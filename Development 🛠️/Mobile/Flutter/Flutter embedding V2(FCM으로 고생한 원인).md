# Flutter embedding V2(FCM으로 고생한 원인)

[https://medium.com/flutter/modern-flutter-plugin-development-4c3ee015cf5a#:~:text=In the old v1 Android,be initialized once per FlutterEngine](https://medium.com/flutter/modern-flutter-plugin-development-4c3ee015cf5a#:~:text=In%20the%20old%20v1%20Android,be%20initialized%20once%20per%20FlutterEngine%20) .

플러터는 안드로이드와 ios 간의 패키지를 효율적으로 상호작용하게끔 만들 필요가있었고

그 결과 embedding v2가 나왔습니다.

여기서 지원하는 것은 플러그인을 연합된 형태의 플러그인으로 구조를 사용하는 것이고

이를 지원하기 위한 방법이나 사용법들을 위의 링크에서 잘 설명하고있습니다.

- 플러그인 등록의 변화

먼저, 전에는 플러그인(전화 앱이나 배터리앱등등)을 사용하면 플러터가 시작하면

바로 사용할 플러그인들을 바로바로 registerWith으로 등록, 초기화 하여

정적으로 사용한 반면,

전화앱 같은 경우에는 해당 액티비티(앱 화면)이 켜져야 쓸모가 있는 플러그인(네이티브 앱)

이므로 이를 사용하기 위해 플러터가 시작하자마자 플러그인들을 전부 등록, 초기화 하는 방식이 비효율적이였습니다.

embedding v2로 바뀌면서 달라진 점은 이런 앱을 사용할때 onAttachedToFlutterEngine()으로

 isolate된 플러그인(main과 다른 영역)에 기본 플러터를 연결을 시켜주고 이후 사용이 끝나면 onDetachedToFlutterEngine()으로 isolate간의 연결을 해제해주면 됩니다.

즉, embedding 버전이 변화함에 따라 플러그인의 수명주기에도 변화가 찾아왔습니다.

이로 인해 fcm같은 패키지들은 예전 v1의 방식으로 패키지들을 등록을 직접 해주어야하는 귀찮은 문제가 발생했습니다.

이것을 해주지 않으면 backgroundmessage와 같은 백그라운드 동작들을 사용할 수 가 없습니다.(백그라운드는 isolate된 영역이므로 직접 정적으로 등록, 초기화를 해주어야 함)

**요약하자면 다른 isolate를 사용하는 패키지들의 접근 방법이**

**정적으로 등록하는 방식에서 인스턴스를 통해 접근하는 방식으로 달라졌기 때문에**

**v1에서 동작하게끔 만들어진 isolate를 사용하는 패키지들은 v2기반인 기본 플러터에 v1방식으로 등록을 해주어야 정상 작동을 하는 것 입니다.**

- 패키지 호출 방법의 변화

기존에 사용하던 패키지가 안드로이드와 IOS에서 호출하는 방법이 다른 패키지라면

각각 파일의 이름과 해당 플러그인의 이름까지도 다르게 적어주어야 했습니다.

이젠 사용하는 플랫폼만 적어주고 플래스이름을 적어주면

플랫폼 각각에 대한 플러그인 사용이 가능해 졌습니다.

거기에 iosprefix키의 지원이 생략되었습니다.

만약 사용하는 플러그인이 안드로이드에서 지원되는 플러그인 클래스의 이름과 파일명,

ios에서 지원되는 클래스의 명과 파일명이 다르면 ios에서 사용하기 위해서는 iosprefix 키로 이와 다르다는 것을 명시을 해주어야했는데

이젠 그냥 파일명 자체를 통일을 시켜주어야하며

이는 iosprefix 키를 사용하는 플러그인만 해당합니다.

거기에 네이티브에 담긴 코드를 불러올때는 예전에는 invokeMethod로 호출을 시켜 사용했지만

**만약 여러 패키지를 통합하여 사용되는 클래스의 경우 각각의 메소드 별로 invokeMethod를 달리해주어 호출해야 하지만 이제는 이 invokeMethod들을 통합하는 인터페이스를 사용해**

**이의 인스턴스로 접근하여 호출해야합니다.(싱글톤화가 필요하다는 말)**

package:mockito

이 해당 패키지는 가상 플랫폼 인터페이스를 제공하며 이를 통해 만들어진 패키지의 호출을 확인 할수 있습니다.

[FCM 백그라운드 메시지 핸들링 미동작 원인 분석 및 해결 방법](Flutter%20embedding%20V2(FCM%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%80%E1%85%A9%E1%84%89%E1%85%A2%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%8B%E1%85%B5%E1%86%AB)%20fde089ede5834a1681c6d356a416d948/FCM%20%E1%84%87%E1%85%A2%E1%86%A8%E1%84%80%E1%85%B3%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%86%AB%E1%84%83%E1%85%B3%20%E1%84%86%E1%85%A6%E1%84%89%E1%85%B5%E1%84%8C%E1%85%B5%20%E1%84%92%E1%85%A2%E1%86%AB%E1%84%83%E1%85%B3%E1%86%AF%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%84%83%E1%85%A9%E1%86%BC%E1%84%8C%E1%85%A1%E1%86%A8%20%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%8B%E1%85%B5%E1%86%AB%20%20e6b4173eb26a436a9e351fd5ec8596bf.md)
